#!/usr/bin/env bash

set -e

build=$1
cache=$2

mkdir -p "$build"
mkdir -p "$cache"

cd "$cache"

# Install dependencies without apt-get update
echo "-----> Installing dependencies"
apt-get install -y build-essential wget git automake libtool || true

# Download and install LZF
echo "-----> Downloading LZF"
wget http://www.oberhumer.com/people/oberhumer/lzo/download/lzo-2.10.tar.gz
tar -zxvf lzo-2.10.tar.gz
cd lzo-2.10
./configure --prefix=/app/lzo
make
make install
cd ..

# Download and install Snappy
echo "-----> Downloading Snappy"
wget https://codeload.github.com/google/snappy/tar.gz/1.1.3 -O snappy.tar.gz
tar -zxvf snappy.tar.gz
cd snappy-1.1.3
./autogen.sh
./configure --prefix=/app/snappy
make
make install
cd ..

# Download and install libpostal
echo "-----> Downloading libpostal"
git clone https://github.com/openvenues/libpostal --depth 1
cd libpostal/
./bootstrap.sh
LDFLAGS="-L$build/lib" CFLAGS="-I$build/include" PKG_CONFIG_PATH="$build/lib/pkgconfig" ./configure --prefix=/app/libpostal --datadir="$build"
cp /app/snappy/include/snappy* include/
make
make install

mv /app/snappy /app/libpostal "$build"


echo "-----> Installation completed successfully"