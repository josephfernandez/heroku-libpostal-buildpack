#!/bin/sh

set -e
set -x  # Enable debugging

BUILD_DIR=$1

echo "-----> Installing libpostal"

# Create installation directories
INSTALL_DIR="$HOME/.heroku/personal-libpostal"
mkdir -p "$INSTALL_DIR/lib/pkgconfig"
mkdir -p "$INSTALL_DIR/include"

# Download and extract libpostal
curl -L https://github.com/openvenues/libpostal/archive/refs/tags/v1.1.tar.gz | tar xz -C "$INSTALL_DIR"

# Check contents of the extracted libpostal directory
ls -l "$INSTALL_DIR/libpostal-1.1"

# Navigate to the extracted directory (check if CMakeLists.txt exists)
cd "$INSTALL_DIR/libpostal-1.1"
mkdir build && cd build
cmake ..
make
make install DESTDIR=$INSTALL_DIR

# Create pkg-config file
cat <<EOF > "$INSTALL_DIR/lib/pkgconfig/libpostal.pc"
prefix=$INSTALL_DIR
libdir=\${prefix}/lib
includedir=\${prefix}/include

Name: libpostal
Description: A library for parsing street addresses
Version: 1.1
Libs: -L\${libdir} -llibpostal
Cflags: -I\${includedir}
EOF

export PKG_CONFIG_PATH="$INSTALL_DIR/lib/pkgconfig:$PKG_CONFIG_PATH"

# Validate installation
if pkg-config --exists libpostal; then
  echo "libpostal is installed correctly."
else
  echo "libpostal installation failed."
  exit 1
fi

echo "-----> libpostal installed"
