#!/bin/sh

set -e
set -x  # Enable debugging

BUILD_DIR=$1
CACHE_DIR=$2
ENV_DIR=$3
BP_DIR=$(cd $(dirname ${0:-}); cd ..; pwd)

echo "-----> Installing libpostal"

# Create installation directories in BUILD_DIR
# mkdir -p $BUILD_DIR
INSTALL_DIR="$CACHE_DIR/personal-libpostal"
mkdir -p "$INSTALL_DIR/lib/pkgconfig"
mkdir -p "$INSTALL_DIR/include"

# Download and extract libpostal
curl -L https://github.com/openvenues/libpostal/archive/refs/tags/v1.1.tar.gz | tar xz -C "$INSTALL_DIR"

# Navigate to the extracted directory
cd "$INSTALL_DIR/libpostal-1.1"

# Prepare the build using Autotools
./bootstrap.sh

# Set LDFLAGS and CFLAGS for the build process
# LDFLAGS="-L$INSTALL_DIR/lib" CFLAGS="-I$INSTALL_DIR/include" PKG_CONFIG_PATH="$INSTALL_DIR/lib/pkgconfig" 
./configure

# Build and install libpostal
make -j4
make install
ldconfig

# # Copy the contents from /app/libpostal
# cp -r /app/libpostal $BUILD_DIR

# # If the copy was successful, remove the original directory
# rm -rf /app/libpostal

# Locate the installed libpostal shared library
LIBPOSTAL_PATH=$(find "$INSTALL_DIR" -name "libpostal.so.1" | head -n 1)

# If libpostal.so.1 is found
if [ -n "$LIBPOSTAL_PATH" ]; then
    # Extract the directory path where the library is located
    LIB_DIR=$(dirname "$LIBPOSTAL_PATH")

    # Export the LD_LIBRARY_PATH and PKG_CONFIG_PATH to include the necessary directories
    echo "export LD_LIBRARY_PATH=\"$LIB_DIR:\$LD_LIBRARY_PATH\"; export PKG_CONFIG_PATH=\"$INSTALL_DIR/lib/pkgconfig:\$PKG_CONFIG_PATH\"" > $BP_DIR/export

    # Add LIBDIR to LD_RUN_PATH to assist with linking
    echo "export LD_RUN_PATH=\"$LIB_DIR:\$LD_RUN_PATH\"" >> $BP_DIR/export

    echo "LD_LIBRARY_PATH and LD_RUN_PATH set. LD_LIBRARY_PATH includes libpostal at $LIB_DIR"
else
    echo "Error: libpostal.so.1 not found."
    exit 1
fi