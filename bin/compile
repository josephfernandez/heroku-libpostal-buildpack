#!/bin/sh

set -e
set -x  # Enable debugging

BUILD_DIR=$1

echo "-----> Installing libpostal"

# Create installation directories
INSTALL_DIR="/app/.heroku/personal-libpostal"
mkdir -p "$INSTALL_DIR/lib/pkgconfig"
mkdir -p "$INSTALL_DIR/include"

# Download and extract libpostal
curl -L https://github.com/openvenues/libpostal/archive/refs/tags/v1.1.tar.gz | tar xz -C "$INSTALL_DIR"

# Check contents of the extracted libpostal directory
ls -l "$INSTALL_DIR/libpostal-1.1"

# Navigate to the extracted directory
cd "$INSTALL_DIR/libpostal-1.1"

# Prepare the build using Autotools
./bootstrap.sh
./configure --prefix="$INSTALL_DIR"

# Build and install
make
make install

# Export PKG_CONFIG_PATH for subsequent commands
export PKG_CONFIG_PATH="$INSTALL_DIR/lib/pkgconfig:$PKG_CONFIG_PATH"
echo "PKG_CONFIG_PATH: $PKG_CONFIG_PATH"

# Validate installation
if pkg-config --exists libpostal; then
  echo "libpostal is installed correctly."
else
  echo "libpostal installation failed."
  exit 1
fi

echo "-----> libpostal installed"